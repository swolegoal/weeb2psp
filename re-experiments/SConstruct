from sconutils import runpretty

env = Environment()
env.Append(CCFLAGS="-O2")

dbg = ARGUMENTS.get("debug", 0)
afl = ARGUMENTS.get("afl", 0)
iniprint = ARGUMENTS.get("print", 0)

# Build C lexer state machines
runpretty("re2c -i -W --verbose re/conftest.c -o build/conftest.c")

if int(iniprint):
    env.Append(CPPDEFINES=["DEBUG_PRINT"])

if int(dbg):
    env.Append(CCFLAGS="-g")

# Regular compilation
env.Program(target="build/conftest", source=["build/conftest.c"])

# Fuzzer compilation
if int(afl):
    env.Append(CCFLAGS="-g")
    env.Replace(CC="afl-gcc")
    env.Program(target="build/conftest-afl", source=["build/conftest.c"])
